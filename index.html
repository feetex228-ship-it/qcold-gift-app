<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            overflow: hidden;
        }

        .error-screen {
            text-align: center;
            padding: 40px;
            max-width: 400px;
        }

        .error-screen h1 {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-screen p {
            font-size: 18px;
            color: #a0a0a0;
            line-height: 1.6;
        }

        /* –≠–∫—Ä–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏ */
        .subscription-screen {
            text-align: center;
            padding: 40px;
            max-width: 400px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .subscription-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .subscription-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subscription-text {
            font-size: 16px;
            color: #a0a0a0;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .subscribe-button {
            display: inline-block;
            padding: 15px 40px;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .subscribe-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        .check-button {
            display: inline-block;
            padding: 12px 35px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .check-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .loading {
            margin-top: 20px;
            color: #a0a0a0;
            font-size: 14px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .container {
            text-align: center;
            padding: 20px;
            max-width: 400px;
            width: 100%;
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 14px;
            color: #a0a0a0;
            margin-bottom: 40px;
        }

        .user-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 20px;
        }

        .admin-badge {
            display: inline-block;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #1a1a2e;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .gift-box-container {
            position: relative;
            margin: 40px auto;
        }

        .gift-box {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            cursor: pointer;
            transition: transform 0.3s ease;
            position: relative;
        }

        .gift-box:hover:not(.disabled) {
            transform: scale(1.05);
        }

        .gift-box.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .gift-box.opening {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        .box {
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, #ff6b6b, #ee5a6f);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(255, 107, 107, 0.4);
            position: relative;
        }

        .box::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(90deg, #ffd93d, #ffb800);
            transform: translateY(-50%);
        }

        .box::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 30px;
            background: linear-gradient(180deg, #ffd93d, #ffb800);
            transform: translateX(-50%);
        }

        .bow {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 40px;
        }

        .bow::before,
        .bow::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            background: #ffd93d;
            border-radius: 50% 50% 0 50%;
        }

        .bow::before {
            left: -5px;
            transform: rotate(-45deg);
        }

        .bow::after {
            right: -5px;
            transform: rotate(45deg);
        }

        .timer {
            margin-top: 30px;
            font-size: 18px;
            color: #ff6b6b;
            font-weight: bold;
        }

        .result {
            margin-top: 30px;
            font-size: 24px;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .prize {
            font-size: 80px;
            animation: prizeAppear 0.6s ease-out;
        }

        @keyframes prizeAppear {
            0% {
                opacity: 0;
                transform: scale(0) rotate(180deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .message {
            margin-top: 10px;
            font-size: 18px;
            color: #a0a0a0;
        }

        .stats {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 16px;
        }

        .stats-label {
            color: #a0a0a0;
        }

        .stats-value {
            color: #fff;
            font-weight: bold;
        }

        .admin-panel {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .admin-title {
            font-size: 18px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .admin-stats {
            margin-top: 15px;
        }

        .admin-stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd93d;
            position: absolute;
            animation: confettiFall 3s linear;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞</div>
    </div>

    <script>
        // ============================================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø - –ò–ó–ú–ï–ù–ò–¢–ï –≠–¢–ò –ó–ù–ê–ß–ï–ù–ò–Ø
        // ============================================
        
        const CONFIG = {
            // Telegram Bot Token - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            BOT_TOKEN: typeof process !== 'undefined' && process.env && process.env.BOT_TOKEN 
                ? process.env.BOT_TOKEN 
                : '8199577977:AAGzxxv6ErQHQwuyUIpiH22dkmyrHrZPcB0',
            
            // Chat ID –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–æ–≤
            LOG_CHAT_ID: typeof process !== 'undefined' && process.env && process.env.LOG_CHAT_ID
                ? process.env.LOG_CHAT_ID
                : '-5221077667',
            
            // –ú–∞—Å—Å–∏–≤ Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
            ADMIN_IDS: typeof process !== 'undefined' && process.env && process.env.ADMIN_IDS
                ? process.env.ADMIN_IDS.split(',').map(id => parseInt(id.trim()))
                : [7697109616],
            
            // Username –∫–∞–Ω–∞–ª–∞ (–±–µ–∑ @) –∏–ª–∏ ID –∫–∞–Ω–∞–ª–∞ –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
            REQUIRED_CHANNEL: typeof process !== 'undefined' && process.env && process.env.REQUIRED_CHANNEL
                ? process.env.REQUIRED_CHANNEL
                : 'Qcoldcrypto', // –ù–∞–ø—Ä–∏–º–µ—Ä: 'my_channel' –∏–ª–∏ '-1001234567890'
            
            // –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
            CHANNEL_LINK: typeof process !== 'undefined' && process.env && process.env.CHANNEL_LINK
                ? process.env.CHANNEL_LINK
                : 'https://t.me/+_oSXetn0FBtlMmNk'
        };

        // ============================================
        // –ü–†–û–í–ï–†–ö–ê –ó–ê–ü–£–°–ö–ê –ß–ï–†–ï–ó TELEGRAM
        // ============================================
        
        let tg = window.Telegram?.WebApp;
        
        if (!tg || !tg.initData) {
            document.getElementById('app').innerHTML = `
                <div class="error-screen">
                    <h1>‚ö†Ô∏è</h1>
                    <p>–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram!</p>
                    <p style="margin-top: 20px; font-size: 14px;">–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç—Ç—É–¥–∞.</p>
                </div>
            `;
            throw new Error('Not running in Telegram');
        }

        tg.expand();
        tg.ready();

        // ============================================
        // –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
        // ============================================
        
        const user = tg.initDataUnsafe?.user;
        const userId = user?.id;
        const userName = user?.username || user?.first_name || 'Unknown';
        const isAdmin = CONFIG.ADMIN_IDS.includes(userId);

        console.log('User ID:', userId);
        console.log('User Name:', userName);
        console.log('Is Admin:', isAdmin);

        // ============================================
        // –ü–†–û–í–ï–†–ö–ê –ü–û–î–ü–ò–°–ö–ò –ù–ê –ö–ê–ù–ê–õ
        // ============================================
        
        async function checkSubscription() {
            if (!CONFIG.BOT_TOKEN || CONFIG.BOT_TOKEN === 'YOUR_BOT_TOKEN_HERE') {
                console.warn('Bot token not configured, skipping subscription check');
                return true;
            }

            if (!CONFIG.REQUIRED_CHANNEL || CONFIG.REQUIRED_CHANNEL === 'YOUR_CHANNEL_USERNAME') {
                console.warn('Channel not configured, skipping subscription check');
                return true;
            }

            try {
                const channelId = CONFIG.REQUIRED_CHANNEL.startsWith('-') 
                    ? CONFIG.REQUIRED_CHANNEL 
                    : '@' + CONFIG.REQUIRED_CHANNEL;

                const response = await fetch(
                    `https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/getChatMember?chat_id=${channelId}&user_id=${userId}`
                );

                const data = await response.json();

                if (!data.ok) {
                    console.error('Subscription check error:', data);
                    return false;
                }

                const status = data.result.status;
                const isSubscribed = ['creator', 'administrator', 'member'].includes(status);

                console.log('Subscription status:', status, 'Subscribed:', isSubscribed);
                return isSubscribed;
            } catch (error) {
                console.error('Error checking subscription:', error);
                return false;
            }
        }

        function showSubscriptionScreen() {
            document.getElementById('app').innerHTML = `
                <div class="subscription-screen">
                    <div class="subscription-icon">üîí</div>
                    <h2 class="subscription-title">–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª</h2>
                    <p class="subscription-text">
                        –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª
                    </p>
                    <div>
                        <a href="${CONFIG.CHANNEL_LINK}" target="_blank" class="subscribe-button">
                            üì¢ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª
                        </a>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="check-button" onclick="recheckSubscription()">
                            ‚úì –Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
                        </button>
                    </div>
                    <div id="checkingStatus"></div>
                </div>
            `;

            sendLog('–ü–æ–∫–∞–∑–∞–Ω —ç–∫—Ä–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏ (–Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –∫–∞–Ω–∞–ª)', 'warning');
        }

        window.recheckSubscription = async function() {
            const statusEl = document.getElementById('checkingStatus');
            statusEl.innerHTML = '<div class="loading">–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É</div>';

            const isSubscribed = await checkSubscription();

            if (isSubscribed) {
                statusEl.innerHTML = '';
                sendLog('–ü–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ –∫–∞–Ω–∞–ª', 'success');
                initializeApp();
            } else {
                statusEl.innerHTML = '<p style="color: #ff6b6b; margin-top: 15px; font-size: 14px;">‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª.</p>';
                setTimeout(() => {
                    statusEl.innerHTML = '';
                }, 3000);
            }
        };

        // ============================================
        // –û–¢–ü–†–ê–í–ö–ê –õ–û–ì–û–í –í TELEGRAM
        // ============================================
        
        async function sendLog(message, type = 'info') {
            if (!CONFIG.BOT_TOKEN || CONFIG.BOT_TOKEN === 'YOUR_BOT_TOKEN_HERE') {
                console.log('[LOG]', message);
                return;
            }

            const emoji = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'gift': 'üéÅ',
                'admin': 'üëë'
            };

            const timestamp = new Date().toLocaleString('ru-RU', { 
                timeZone: 'Europe/Moscow' 
            });

            const logMessage = `${emoji[type] || '‚ÑπÔ∏è'} <b>${type.toUpperCase()}</b>\n\n` +
                `üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> ${userName} (ID: ${userId})\n` +
                `‚è∞ <b>–í—Ä–µ–º—è:</b> ${timestamp}\n` +
                `üìù <b>–°–æ–±—ã—Ç–∏–µ:</b> ${message}`;

            try {
                const response = await fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: CONFIG.LOG_CHAT_ID,
                        text: logMessage,
                        parse_mode: 'HTML'
                    })
                });

                if (!response.ok) {
                    console.error('Failed to send log to Telegram');
                }
            } catch (error) {
                console.error('Error sending log:', error);
            }
        }

        // ============================================
        // –•–†–ê–ù–ò–õ–ò–©–ï –î–ê–ù–ù–´–•
        // ============================================
        
        const STORAGE_KEY = 'giftBoxData';
        const GLOBAL_STATS_KEY = 'globalStats';
        
        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY + '_' + userId);
            if (saved) {
                return JSON.parse(saved);
            }
            return {
                lastOpen: 0,
                totalOpens: 0,
                bearsFound: 0
            };
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY + '_' + userId, JSON.stringify(data));
            updateGlobalStats();
        }

        function loadGlobalStats() {
            const saved = localStorage.getItem(GLOBAL_STATS_KEY);
            if (saved) {
                return JSON.parse(saved);
            }
            return {
                totalUsers: 0,
                totalOpens: 0,
                totalBears: 0,
                users: {}
            };
        }

        function updateGlobalStats() {
            const globalStats = loadGlobalStats();
            
            if (!globalStats.users[userId]) {
                globalStats.totalUsers++;
            }
            
            globalStats.users[userId] = {
                name: userName,
                data: gameData,
                lastActivity: Date.now()
            };
            
            globalStats.totalOpens = 0;
            globalStats.totalBears = 0;
            
            for (let uid in globalStats.users) {
                globalStats.totalOpens += globalStats.users[uid].data.totalOpens || 0;
                globalStats.totalBears += globalStats.users[uid].data.bearsFound || 0;
            }
            
            localStorage.setItem(GLOBAL_STATS_KEY, JSON.stringify(globalStats));
        }

        let gameData = loadData();

        // ============================================
        // –û–¢–†–ò–°–û–í–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê
        // ============================================
        
        function renderApp() {
            const adminPanel = isAdmin ? `
                <div class="admin-panel">
                    <div class="admin-title">
                        üëë –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
                    </div>
                    <div class="admin-stats" id="adminStats">
                        –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...
                    </div>
                </div>
            ` : '';

            document.getElementById('app').innerHTML = `
                <div class="container">
                    <h1 class="title">üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫</h1>
                    <p class="subtitle">–û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –∫–µ–π—Å —Ä–∞–∑ –≤ 24 —á–∞—Å–∞</p>
                    <div class="user-info">
                        –ü—Ä–∏–≤–µ—Ç, ${userName}! ${isAdmin ? '<span class="admin-badge">ADMIN</span>' : ''}
                    </div>

                    <div class="gift-box-container">
                        <div class="gift-box" id="giftBox">
                            <div class="box">
                                <div class="bow"></div>
                            </div>
                        </div>
                    </div>

                    <div class="timer" id="timer"></div>

                    <div class="result" id="result"></div>

                    <div class="stats">
                        <div class="stats-item">
                            <span class="stats-label">–í—Å–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏–π:</span>
                            <span class="stats-value" id="totalOpens">0</span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">–ú–∏—à–µ–∫ –Ω–∞–π–¥–µ–Ω–æ:</span>
                            <span class="stats-value" id="bearsFound">0</span>
                        </div>
                    </div>

                    ${adminPanel}
                </div>
            `;

            initApp();
        }

        // ============================================
        // –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // ============================================
        
        function initApp() {
            const giftBox = document.getElementById('giftBox');
            const timer = document.getElementById('timer');
            const result = document.getElementById('result');
            const totalOpensEl = document.getElementById('totalOpens');
            const bearsFoundEl = document.getElementById('bearsFound');

            updateStats();
            updateTimer();
            
            if (isAdmin) {
                updateAdminStats();
            }
            
            setInterval(updateTimer, 1000);
            giftBox.addEventListener('click', openGiftBox);

            function updateStats() {
                totalOpensEl.textContent = gameData.totalOpens;
                bearsFoundEl.textContent = gameData.bearsFound;
            }

            function canOpen() {
                const now = Date.now();
                const timeSinceLastOpen = now - gameData.lastOpen;
                const ONE_DAY = 24 * 60 * 60 * 1000;
                return timeSinceLastOpen >= ONE_DAY;
            }

            function formatTime(ms) {
                const hours = Math.floor(ms / (1000 * 60 * 60));
                const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((ms % (1000 * 60)) / 1000);
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            function updateTimer() {
                if (canOpen()) {
                    timer.textContent = '‚ú® –ì–æ—Ç–æ–≤ –∫ –æ—Ç–∫—Ä—ã—Ç–∏—é!';
                    giftBox.classList.remove('disabled');
                } else {
                    const now = Date.now();
                    const timeLeft = (24 * 60 * 60 * 1000) - (now - gameData.lastOpen);
                    timer.textContent = `‚è∞ –î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è: ${formatTime(timeLeft)}`;
                    giftBox.classList.add('disabled');
                }
            }

            function createConfetti() {
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * 100 + '%';
                        confetti.style.background = ['#ffd93d', '#ff6b6b', '#4ecdc4', '#95e1d3'][Math.floor(Math.random() * 4)];
                        confetti.style.animationDelay = Math.random() * 0.5 + 's';
                        document.body.appendChild(confetti);
                        
                        setTimeout(() => confetti.remove(), 3000);
                    }, i * 30);
                }
            }

            function openGiftBox() {
                if (!canOpen()) {
                    tg.showAlert('‚è∞ –í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏ –∫–µ–π—Å —Å–µ–≥–æ–¥–Ω—è! –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞.');
                    sendLog('–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏', 'warning');
                    return;
                }

                giftBox.classList.add('opening');
                result.innerHTML = '';
                
                setTimeout(() => {
                    giftBox.classList.remove('opening');
                    
                    const won = Math.random() < 0.5;
                    
                    gameData.lastOpen = Date.now();
                    gameData.totalOpens++;
                    
                    if (won) {
                        gameData.bearsFound++;
                        result.innerHTML = `
                            <div class="prize">üß∏</div>
                            <div class="message">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ –º–∏—à–∫—É!</div>
                        `;
                        createConfetti();
                        tg.showAlert('üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –º–∏—à–∫—É! üß∏');
                        sendLog(`–í—ã–∏–≥—Ä–∞–ª –º–∏—à–∫—É! üß∏ (–í—Å–µ–≥–æ –º–∏—à–µ–∫: ${gameData.bearsFound})`, 'gift');
                    } else {
                        result.innerHTML = `
                            <div class="prize">üì¶</div>
                            <div class="message">–ü—É—Å—Ç–æ... –£–¥–∞—á–∏ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑!</div>
                        `;
                        tg.showAlert('üòî –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ —ç—Ç–æ—Ç —Ä–∞–∑ –ø—É—Å—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≤—Ç—Ä–∞!');
                        sendLog('–û—Ç–∫—Ä—ã–ª –∫–µ–π—Å, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–ø–∞–ª–æ', 'info');
                    }
                    
                    saveData(gameData);
                    updateStats();
                    updateTimer();
                    
                    if (isAdmin) {
                        updateAdminStats();
                    }
                }, 500);
            }

            function updateAdminStats() {
                const adminStatsEl = document.getElementById('adminStats');
                if (!adminStatsEl) return;

                const globalStats = loadGlobalStats();
                
                let topUsers = Object.entries(globalStats.users)
                    .map(([id, data]) => ({
                        id,
                        name: data.name,
                        opens: data.data.totalOpens || 0,
                        bears: data.data.bearsFound || 0
                    }))
                    .sort((a, b) => b.bears - a.bears)
                    .slice(0, 5);

                const winRate = globalStats.totalOpens > 0 
                    ? ((globalStats.totalBears / globalStats.totalOpens) * 100).toFixed(1)
                    : 0;

                adminStatsEl.innerHTML = `
                    <div class="admin-stat-item">
                        <span class="stats-label">üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</span>
                        <span class="stats-value">${globalStats.totalUsers}</span>
                    </div>
                    <div class="admin-stat-item">
                        <span class="stats-label">üì¶ –í—Å–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏–π:</span>
                        <span class="stats-value">${globalStats.totalOpens}</span>
                    </div>
                    <div class="admin-stat-item">
                        <span class="stats-label">üß∏ –í—Å–µ–≥–æ –º–∏—à–µ–∫:</span>
                        <span class="stats-value">${globalStats.totalBears}</span>
                    </div>
                    <div class="admin-stat-item">
                        <span class="stats-label">üìä –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥:</span>
                        <span class="stats-value">${winRate}%</span>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 215, 0, 0.3);">
                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #ffd700;">
                            üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤:
                        </div>
                        ${topUsers.length > 0 ? topUsers.map((u, i) => `
                            <div class="admin-stat-item" style="font-size: 12px;">
                                <span>${i + 1}. ${u.name}</span>
                                <span>üß∏ ${u.bears} (${u.opens} –æ—Ç–∫—Ä.)</span>
                            </div>
                        `).join('') : '<p style="text-align: center; color: #666;">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>'}
                    </div>
                `;
            }
        }

        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // ============================================
        
        async function initializeApp() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∫–∞–Ω–∞–ª
            const isSubscribed = await checkSubscription();

            if (!isSubscribed) {
                showSubscriptionScreen();
                return;
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–≥ –æ –≤—Ö–æ–¥–µ
            sendLog('–û—Ç–∫—Ä—ã–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', 'info');

            // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            renderApp();
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        initializeApp();
    </script>
</body>
</html>
