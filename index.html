<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            overflow: hidden;
        }

        .error-screen {
            text-align: center;
            padding: 40px;
            max-width: 400px;
        }

        .error-screen h1 {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-screen p {
            font-size: 18px;
            color: #a0a0a0;
            line-height: 1.6;
        }

        /* –≠–∫—Ä–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏ */
        .subscription-screen {
            text-align: center;
            padding: 40px;
            max-width: 400px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .subscription-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .subscription-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subscription-text {
            font-size: 16px;
            color: #a0a0a0;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .subscribe-button {
            display: inline-block;
            padding: 15px 40px;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .subscribe-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        .check-button {
            display: inline-block;
            padding: 12px 35px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .check-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .loading {
            margin-top: 20px;
            color: #a0a0a0;
            font-size: 14px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .container {
            text-align: center;
            padding: 20px;
            max-width: 400px;
            width: 100%;
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 14px;
            color: #a0a0a0;
            margin-bottom: 40px;
        }

        .user-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 20px;
        }

        .admin-badge {
            display: inline-block;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #1a1a2e;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        /* –¢–∞–±—ã */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #fff;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(45deg, #f093fb, #f5576c);
        }

        .tab:hover {
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .gift-box-container {
            position: relative;
            margin: 40px auto;
        }

        .gift-box {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            cursor: pointer;
            transition: transform 0.3s ease;
            position: relative;
        }

        .gift-box:hover:not(.disabled) {
            transform: scale(1.05);
        }

        .gift-box.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .gift-box.opening {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        .box {
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, #ff6b6b, #ee5a6f);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(255, 107, 107, 0.4);
            position: relative;
        }

        .box::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(90deg, #ffd93d, #ffb800);
            transform: translateY(-50%);
        }

        .bow {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 40px;
        }

        .bow::before,
        .bow::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 40px;
            background: linear-gradient(135deg, #ffd93d, #ffb800);
            border-radius: 50% 50% 0 50%;
        }

        .bow::before {
            left: 0;
            transform: rotate(-45deg);
        }

        .bow::after {
            right: 0;
            transform: rotate(45deg) scaleX(-1);
        }

        .timer {
            font-size: 16px;
            color: #4ecdc4;
            margin: 20px 0;
            font-weight: bold;
        }

        .result {
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

        .prize {
            font-size: 80px;
            margin-bottom: 10px;
            animation: prizeAppear 0.5s ease-out;
        }

        @keyframes prizeAppear {
            from {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .message {
            font-size: 18px;
            font-weight: bold;
            color: #4ecdc4;
            animation: fadeIn 0.5s ease-out 0.3s both;
        }

        .stats {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stats-item:last-child {
            border-bottom: none;
        }

        .stats-label {
            color: #a0a0a0;
            font-size: 14px;
        }

        .stats-value {
            color: #4ecdc4;
            font-weight: bold;
            font-size: 16px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            animation: confettiFall 3s linear forwards;
            z-index: 1000;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å */
        .admin-panel {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 20px;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .admin-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ffd700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-stats {
            text-align: left;
        }

        .admin-stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }

        .admin-stat-item:last-child {
            border-bottom: none;
        }

        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ */
        .user-management {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 215, 0, 0.3);
        }

        .user-search {
            margin-bottom: 15px;
        }

        .user-search input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
        }

        .user-search input::placeholder {
            color: #666;
        }

        .user-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-item-info {
            flex: 1;
            text-align: left;
        }

        .user-item-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .user-item-id {
            font-size: 11px;
            color: #666;
        }

        .user-item-cooldown {
            font-size: 12px;
            color: #4ecdc4;
            margin-top: 4px;
        }

        .reset-btn {
            padding: 8px 16px;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(240, 147, 251, 0.4);
        }

        .reset-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="error-screen">
            <h1>‚ö†Ô∏è</h1>
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram</p>
        </div>
    </div>

    <script>
        // ============================================
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        // ============================================
        
        const tg = window.Telegram.WebApp;
        const CHANNEL_USERNAME = 'sosi_sobake';
        const BOT_TOKEN = '8162842990:AAH1s-HnYYIApLIUAiDZRaFP7BWFOV4dv_I';
        const CHANNEL_CHAT_ID = '-1002461959029';
        const ADMIN_IDS = [7419627121];

        let userId, userName, isAdmin;
        let gameData = {
            lastOpen: 0,
            totalOpens: 0,
            bearsFound: 0
        };

        // ============================================
        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // ============================================
        
        function saveData(data) {
            const storageKey = `giftBox_${userId}`;
            localStorage.setItem(storageKey, JSON.stringify(data));
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const globalStats = loadGlobalStats();
            globalStats.users[userId] = {
                name: userName,
                data: data,
                lastActivity: Date.now()
            };
            saveGlobalStats(globalStats);
        }

        function loadData() {
            const storageKey = `giftBox_${userId}`;
            const saved = localStorage.getItem(storageKey);
            return saved ? JSON.parse(saved) : {
                lastOpen: 0,
                totalOpens: 0,
                bearsFound: 0
            };
        }

        function loadGlobalStats() {
            const saved = localStorage.getItem('giftBox_globalStats');
            if (saved) {
                return JSON.parse(saved);
            }
            return {
                users: {},
                totalUsers: 0,
                totalOpens: 0,
                totalBears: 0
            };
        }

        function saveGlobalStats(stats) {
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const userCount = Object.keys(stats.users).length;
            let totalOpens = 0;
            let totalBears = 0;

            Object.values(stats.users).forEach(user => {
                totalOpens += user.data.totalOpens || 0;
                totalBears += user.data.bearsFound || 0;
            });

            stats.totalUsers = userCount;
            stats.totalOpens = totalOpens;
            stats.totalBears = totalBears;

            localStorage.setItem('giftBox_globalStats', JSON.stringify(stats));
        }

        async function sendLog(message, type = 'info') {
            const emoji = {
                'info': '‚ÑπÔ∏è',
                'warning': '‚ö†Ô∏è',
                'error': '‚ùå',
                'success': '‚úÖ',
                'gift': 'üéÅ'
            };

            const logMessage = `${emoji[type] || '‚ÑπÔ∏è'} ${message}\n\nüë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userName}\nüÜî ID: ${userId}\n‚è∞ –í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU')}`;

            try {
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: CHANNEL_CHAT_ID,
                        text: logMessage,
                        parse_mode: 'HTML'
                    })
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞:', error);
            }
        }

        async function checkSubscription() {
            try {
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getChatMember?chat_id=@${CHANNEL_USERNAME}&user_id=${userId}`);
                const data = await response.json();
                
                if (data.ok) {
                    const status = data.result.status;
                    return ['creator', 'administrator', 'member'].includes(status);
                }
                return false;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏:', error);
                return false;
            }
        }

        // ============================================
        // –ò–ù–¢–ï–†–§–ï–ô–° –ü–û–î–ü–ò–°–ö–ò
        // ============================================
        
        function showSubscriptionScreen() {
            document.getElementById('app').innerHTML = `
                <div class="subscription-screen">
                    <div class="subscription-icon">üîí</div>
                    <h2 class="subscription-title">–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª</h2>
                    <p class="subscription-text">
                        –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—à Telegram-–∫–∞–Ω–∞–ª
                    </p>
                    <a href="https://t.me/${CHANNEL_USERNAME}" class="subscribe-button" target="_blank">
                        –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª
                    </a>
                    <br>
                    <button class="check-button" onclick="recheckSubscription()">
                        –Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è
                    </button>
                    <div class="loading" id="checkingStatus" style="display: none;">
                        –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
                    </div>
                </div>
            `;
        }

        async function recheckSubscription() {
            const button = document.querySelector('.check-button');
            const loading = document.getElementById('checkingStatus');
            
            button.style.display = 'none';
            loading.style.display = 'block';
            
            const isSubscribed = await checkSubscription();
            
            if (isSubscribed) {
                initializeApp();
            } else {
                loading.style.display = 'none';
                button.style.display = 'inline-block';
                tg.showAlert('‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            }
        }

        // ============================================
        // –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–°
        // ============================================
        
        function renderApp() {
            gameData = loadData();

            const tabs = isAdmin ? `
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('game')">üéÅ –ò–≥—Ä–∞</button>
                    <button class="tab" onclick="switchTab('admin')">‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞</button>
                </div>
            ` : '';

            const gameContent = `
                <h1 class="title">üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫</h1>
                <p class="subtitle">–û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –∫–µ–π—Å —Ä–∞–∑ –≤ 24 —á–∞—Å–∞</p>
                <div class="user-info">
                    –ü—Ä–∏–≤–µ—Ç, ${userName}! ${isAdmin ? '<span class="admin-badge">ADMIN</span>' : ''}
                </div>

                <div class="gift-box-container">
                    <div class="gift-box" id="giftBox">
                        <div class="box">
                            <div class="bow"></div>
                        </div>
                    </div>
                </div>

                <div class="timer" id="timer"></div>

                <div class="result" id="result"></div>

                <div class="stats">
                    <div class="stats-item">
                        <span class="stats-label">–í—Å–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏–π:</span>
                        <span class="stats-value" id="totalOpens">0</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">–ú–∏—à–µ–∫ –Ω–∞–π–¥–µ–Ω–æ:</span>
                        <span class="stats-value" id="bearsFound">0</span>
                    </div>
                </div>
            `;

            const adminContent = isAdmin ? `
                <div class="admin-panel">
                    <div class="admin-title">
                        üëë –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                    </div>
                    <div class="admin-stats" id="adminStats">
                        –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...
                    </div>
                    <div class="user-management">
                        <div class="admin-title" style="font-size: 16px;">
                            üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
                        </div>
                        <div class="user-search">
                            <input type="text" id="userSearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –∏–º–µ–Ω–∏..." oninput="filterUsers()">
                        </div>
                        <div class="user-list" id="userList">
                            –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...
                        </div>
                    </div>
                </div>
            ` : '';

            document.getElementById('app').innerHTML = `
                <div class="container">
                    ${tabs}
                    <div class="tab-content active" id="gameTab">
                        ${gameContent}
                    </div>
                    ${isAdmin ? `<div class="tab-content" id="adminTab">${adminContent}</div>` : ''}
                </div>
            `;

            initApp();
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));

            if (tabName === 'game') {
                tabs[0].classList.add('active');
                document.getElementById('gameTab').classList.add('active');
            } else if (tabName === 'admin') {
                tabs[1].classList.add('active');
                document.getElementById('adminTab').classList.add('active');
                updateAdminStats();
                updateUserList();
            }
        }

        function filterUsers() {
            const searchValue = document.getElementById('userSearch').value.toLowerCase();
            const globalStats = loadGlobalStats();
            const users = Object.entries(globalStats.users);

            const filtered = users.filter(([id, data]) => {
                return id.includes(searchValue) || 
                       data.name.toLowerCase().includes(searchValue);
            });

            displayUserList(filtered);
        }

        function displayUserList(users) {
            const userListEl = document.getElementById('userList');
            if (!userListEl) return;

            if (users.length === 0) {
                userListEl.innerHTML = '<p style="text-align: center; color: #666;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            userListEl.innerHTML = users.map(([id, data]) => {
                const canOpen = Date.now() - (data.data.lastOpen || 0) >= 24 * 60 * 60 * 1000;
                const timeLeft = canOpen ? 0 : (24 * 60 * 60 * 1000) - (Date.now() - data.data.lastOpen);
                
                return `
                    <div class="user-item">
                        <div class="user-item-info">
                            <div class="user-item-name">${data.name}</div>
                            <div class="user-item-id">ID: ${id}</div>
                            <div class="user-item-cooldown">
                                ${canOpen ? '‚úÖ –ì–æ—Ç–æ–≤ –∫ –æ—Ç–∫—Ä—ã—Ç–∏—é' : `‚è∞ ${formatTime(timeLeft)}`}
                            </div>
                        </div>
                        <button class="reset-btn" onclick="resetUserCooldown('${id}')" ${canOpen ? 'disabled' : ''}>
                            üîÑ –°–±—Ä–æ—Å–∏—Ç—å
                        </button>
                    </div>
                `;
            }).join('');
        }

        function updateUserList() {
            const globalStats = loadGlobalStats();
            const users = Object.entries(globalStats.users).sort((a, b) => 
                (b[1].data.bearsFound || 0) - (a[1].data.bearsFound || 0)
            );
            displayUserList(users);
        }

        function resetUserCooldown(targetUserId) {
            const globalStats = loadGlobalStats();
            
            if (globalStats.users[targetUserId]) {
                globalStats.users[targetUserId].data.lastOpen = 0;
                saveGlobalStats(globalStats);
                
                // –ï—Å–ª–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (targetUserId == userId) {
                    gameData.lastOpen = 0;
                    saveData(gameData);
                    updateTimer();
                }
                
                updateUserList();
                sendLog(`–ê–¥–º–∏–Ω —Å–±—Ä–æ—Å–∏–ª cooldown –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${globalStats.users[targetUserId].name} (ID: ${targetUserId})`, 'info');
                tg.showAlert('‚úÖ –ö—É–ª–¥–∞—É–Ω —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω!');
            }
        }

        // ============================================
        // –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // ============================================
        
        function initApp() {
            const giftBox = document.getElementById('giftBox');
            const timer = document.getElementById('timer');
            const result = document.getElementById('result');
            const totalOpensEl = document.getElementById('totalOpens');
            const bearsFoundEl = document.getElementById('bearsFound');

            updateStats();
            updateTimer();
            
            if (isAdmin) {
                updateAdminStats();
            }
            
            setInterval(updateTimer, 1000);
            giftBox.addEventListener('click', openGiftBox);

            function updateStats() {
                totalOpensEl.textContent = gameData.totalOpens;
                bearsFoundEl.textContent = gameData.bearsFound;
            }

            function canOpen() {
                const now = Date.now();
                const timeSinceLastOpen = now - gameData.lastOpen;
                const ONE_DAY = 24 * 60 * 60 * 1000;
                return timeSinceLastOpen >= ONE_DAY;
            }

            function updateTimer() {
                if (canOpen()) {
                    timer.textContent = '‚ú® –ì–æ—Ç–æ–≤ –∫ –æ—Ç–∫—Ä—ã—Ç–∏—é!';
                    giftBox.classList.remove('disabled');
                } else {
                    const now = Date.now();
                    const timeLeft = (24 * 60 * 60 * 1000) - (now - gameData.lastOpen);
                    timer.textContent = `‚è∞ –î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è: ${formatTime(timeLeft)}`;
                    giftBox.classList.add('disabled');
                }
            }

            function createConfetti() {
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * 100 + '%';
                        confetti.style.background = ['#ffd93d', '#ff6b6b', '#4ecdc4', '#95e1d3'][Math.floor(Math.random() * 4)];
                        confetti.style.animationDelay = Math.random() * 0.5 + 's';
                        document.body.appendChild(confetti);
                        
                        setTimeout(() => confetti.remove(), 3000);
                    }, i * 30);
                }
            }

            function openGiftBox() {
                if (!canOpen()) {
                    tg.showAlert('‚è∞ –í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏ –∫–µ–π—Å —Å–µ–≥–æ–¥–Ω—è! –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞.');
                    return;
                }

                giftBox.classList.add('opening');
                result.innerHTML = '';
                
                setTimeout(() => {
                    giftBox.classList.remove('opening');
                    
                    const won = Math.random() < 0.5;
                    
                    gameData.lastOpen = Date.now();
                    gameData.totalOpens++;
                    
                    if (won) {
                        gameData.bearsFound++;
                        result.innerHTML = `
                            <div class="prize">üß∏</div>
                            <div class="message">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ –º–∏—à–∫—É!</div>
                        `;
                        createConfetti();
                        tg.showAlert('üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –º–∏—à–∫—É! üß∏');
                        sendLog(`–í—ã–∏–≥—Ä–∞–ª –º–∏—à–∫—É! üß∏ (–í—Å–µ–≥–æ –º–∏—à–µ–∫: ${gameData.bearsFound})`, 'gift');
                    } else {
                        result.innerHTML = `
                            <div class="prize">üì¶</div>
                            <div class="message">–ü—É—Å—Ç–æ... –£–¥–∞—á–∏ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑!</div>
                        `;
                        tg.showAlert('üòî –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ —ç—Ç–æ—Ç —Ä–∞–∑ –ø—É—Å—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≤—Ç—Ä–∞!');
                        sendLog('–û—Ç–∫—Ä—ã–ª –∫–µ–π—Å, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–ø–∞–ª–æ', 'info');
                    }
                    
                    saveData(gameData);
                    updateStats();
                    updateTimer();
                    
                    if (isAdmin) {
                        updateAdminStats();
                    }
                }, 500);
            }
        }

        function formatTime(ms) {
            const hours = Math.floor(ms / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((ms % (1000 * 60)) / 1000);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateAdminStats() {
            const adminStatsEl = document.getElementById('adminStats');
            if (!adminStatsEl) return;

            const globalStats = loadGlobalStats();
            
            let topUsers = Object.entries(globalStats.users)
                .map(([id, data]) => ({
                    id,
                    name: data.name,
                    opens: data.data.totalOpens || 0,
                    bears: data.data.bearsFound || 0
                }))
                .sort((a, b) => b.bears - a.bears)
                .slice(0, 5);

            const winRate = globalStats.totalOpens > 0 
                ? ((globalStats.totalBears / globalStats.totalOpens) * 100).toFixed(1)
                : 0;

            adminStatsEl.innerHTML = `
                <div class="admin-stat-item">
                    <span class="stats-label">üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</span>
                    <span class="stats-value">${globalStats.totalUsers}</span>
                </div>
                <div class="admin-stat-item">
                    <span class="stats-label">üì¶ –í—Å–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏–π:</span>
                    <span class="stats-value">${globalStats.totalOpens}</span>
                </div>
                <div class="admin-stat-item">
                    <span class="stats-label">üß∏ –í—Å–µ–≥–æ –º–∏—à–µ–∫:</span>
                    <span class="stats-value">${globalStats.totalBears}</span>
                </div>
                <div class="admin-stat-item">
                    <span class="stats-label">üìä –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥:</span>
                    <span class="stats-value">${winRate}%</span>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 215, 0, 0.3);">
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #ffd700;">
                        üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤:
                    </div>
                    ${topUsers.length > 0 ? topUsers.map((u, i) => `
                        <div class="admin-stat-item" style="font-size: 12px;">
                            <span>${i + 1}. ${u.name}</span>
                            <span>üß∏ ${u.bears} (${u.opens} –æ—Ç–∫—Ä.)</span>
                        </div>
                    `).join('') : '<p style="text-align: center; color: #666;">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>'}
                </div>
            `;
        }

        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // ============================================
        
        async function initializeApp() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∫–∞–Ω–∞–ª
            const isSubscribed = await checkSubscription();

            if (!isSubscribed) {
                showSubscriptionScreen();
                return;
            }

            // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            renderApp();
        }

        // ============================================
        // –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // ============================================
        
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            tg.ready();
            tg.expand();

            userId = tg.initDataUnsafe.user.id;
            userName = tg.initDataUnsafe.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            isAdmin = ADMIN_IDS.includes(userId);

            initializeApp();
        } else {
            document.getElementById('app').innerHTML = `
                <div class="error-screen">
                    <h1>‚ö†Ô∏è</h1>
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram</p>
                </div>
            `;
        }
    </script>
</body>
</html>
